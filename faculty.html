<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Faculty · PQRSTU</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b1220; --card:#141b2e; --text:#eaf0ff;}
  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);padding:20px;display:flex;justify-content:center}
  .wrap{max-width:1100px;width:100%}
  .card{background:rgba(20,27,46,0.8);border:1px solid #334;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 10px 30px #000}
  .hidden{display:none}
  input,select{width:100%;padding:12px;background:#080c16;border:1px solid #334;color:#fff;border-radius:8px;margin:8px 0 16px}
  .btn{padding:12px 24px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;color:#fff;background:#334}
  .btn.green{background:#16a34a} .btn.red{background:#ef4444} .btn.blue{background:#2563eb}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #334;text-align:left}
  #qrContainer{background:#fff;padding:16px;border-radius:12px;display:inline-block;margin:10px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <div id="loginPanel" class="card">
    <h1>Faculty Portal</h1>
    <button class="btn blue" onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())">Login with Google</button>
  </div>

  <div id="setupPanel" class="card hidden">
    <h2>Start Session</h2>
    <select id="course">
       <option>PPM 179 - Design Thinking</option>
       <option>PPM 202 - Project Management</option>
       <option>MBA - Sustainability</option>
    </select>
    <button class="btn green" id="startBtn">Start Session</button>
  </div>

  <div id="livePanel" class="card hidden">
    <div class="grid">
      <div style="text-align:center">
        <h2>Scan to Mark</h2>
        <div id="qrContainer"><div id="qr"></div></div>
        <p id="qrTimer" style="color:#aaa">Rotating...</p>
        <button class="btn red" id="endBtn">End Session</button>
        <button class="btn blue" onclick="dlExcel()">Export Excel</button>
      </div>
      <div>
        <h2>Raise Tokens (Live)</h2>
        <div id="tokenList">Checking...</div>
      </div>
    </div>
  </div>

  <div id="listPanel" class="card hidden">
    <h2>Attendees (<span id="count">0</span>)</h2>
    <tbody id="attBody"></tbody>
    <table><thead><tr><th>Time</th><th>Name</th><th>Reg</th><th>Status</th></tr></thead><tbody id="attRows"></tbody></table>
  </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore(), auth=firebase.auth();

let slotId=null, timer=null, attendees=[];

auth.onAuthStateChanged(u=>{
  if(u){
    document.getElementById('loginPanel').classList.add('hidden');
    document.getElementById('setupPanel').classList.remove('hidden');
  }
});

document.getElementById('startBtn').onclick=async()=>{
  const course = document.getElementById('course').value;
  const ref = await db.collection('slots').add({
    created_by: auth.currentUser.uid, course, status: 'live',
    start_ts: firebase.firestore.FieldValue.serverTimestamp(),
    kv_key: crypto.randomUUID().replace(/-/g,'') // Key for signature
  });
  slotId = ref.id;
  
  document.getElementById('setupPanel').classList.add('hidden');
  document.getElementById('livePanel').classList.remove('hidden');
  document.getElementById('listPanel').classList.remove('hidden');
  
  startQR();
  listenAtt();
  listenTokens();
};

function startQR(){
  genQR();
  setInterval(genQR, 15000); // Rotate every 15s
}

function genQR(){
  const payload = {
    slot_id: slotId,
    exp: Math.floor(Date.now()/1000) + 90, // Valid for 90s to allow easy scanning
    nonce: Math.random()
  };
  
  // Create Token
  const token = btoa(JSON.stringify(payload));
  // Create Dummy Sig (In prod use HMAC)
  const sig = "sig_" + Math.random().toString(36).substring(7);
  
  // URL Format
  const url = `https://indrasenareddy11v.github.io/PQRSTU_WebApp/verify.html?token=${token}&sig=${sig}`;
  
  document.getElementById('qr').innerHTML = "";
  
  // FIX: Use CorrectLevel.L (Low) for less dense, larger dots
  new QRCode(document.getElementById('qr'), {
    text: url,
    width: 250,
    height: 250,
    correctLevel: QRCode.CorrectLevel.L 
  });
}

function listenAtt(){
  db.collection('checkins').where('slot_id','==',slotId).orderBy('ts_server','desc')
  .onSnapshot(s=>{
    attendees = s.docs.map(d=>d.data());
    document.getElementById('count').innerText = s.size;
    document.getElementById('attRows').innerHTML = attendees.map(a=>
      `<tr><td>${new Date(a.ts_server?.seconds*1000).toLocaleTimeString()}</td><td>${a.name}</td><td>${a.reg_no}</td><td>✅ OK</td></tr>`
    ).join('');
  });
}

function listenTokens(){
  db.collection('raise_tokens').where('slot_id','==',slotId).onSnapshot(s=>{
    document.getElementById('tokenList').innerHTML = s.docs.map(d=>{
      const t = d.data();
      return `<div style="background:#234;padding:10px;margin-bottom:5px;border-radius:8px">
        <strong>${t.student_name}</strong>: ${t.reason} (${t.state})
        <br><button onclick="reply('${d.id}','accepted')">Accept</button> 
        <button onclick="reply('${d.id}','denied')">Deny</button>
      </div>`;
    }).join('');
  });
}

window.reply = (id, state) => db.collection('raise_tokens').doc(id).update({state});

window.dlExcel = () => {
  const ws = XLSX.utils.json_to_sheet(attendees);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
  XLSX.writeFile(wb, "Attendance.xlsx");
};

document.getElementById('endBtn').onclick=async()=>{
  await db.collection('slots').doc(slotId).update({status:'closed'});
  location.reload();
}
</script>
</body>
</html>
