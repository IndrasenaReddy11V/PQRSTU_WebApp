<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Faculty · PQRSTU</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b1220; --card:#141b2e; --text:#eaf0ff; --accent:#3b82f6;}
  body{
    margin:0; font-family:Inter,sans-serif; background:var(--bg); color:var(--text);
    padding:20px; display:flex; justify-content:center;
  }
  .wrap{max-width:1100px; width:100%;}
  .card{
    background:rgba(20,27,46,0.7); border:1px solid rgba(255,255,255,0.1);
    border-radius:16px; padding:24px; margin-bottom:20px;
    backdrop-filter:blur(10px);
  }
  .hidden{display:none}
  h1,h2{margin-top:0}
  
  /* Form Elements */
  input, select{
    width:100%; padding:12px; background:#080c16; border:1px solid #334;
    color:#fff; border-radius:8px; margin:8px 0 16px;
  }
  .grid {display:grid; grid-template-columns:1fr 1fr; gap:20px}
  
  /* Buttons */
  .btn{
    padding:12px 24px; border-radius:8px; border:none; cursor:pointer;
    font-weight:bold; color:#fff; background:#334; transition:0.2s;
  }
  .btn:hover{filter:brightness(1.2)}
  .btn.green{background:#16a34a}
  .btn.red{background:#ef4444}
  .btn.blue{background:#2563eb}
  
  /* Table */
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th{text-align:left; color:#889; font-size:12px; padding-bottom:8px}
  td{padding:8px 0; border-bottom:1px solid #334}
  
  /* QR Box */
  #qrContainer{
    background:#fff; padding:16px; border-radius:12px; display:inline-block;
    margin:10px 0;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>

<div class="wrap">
  <div id="loginPanel" class="card">
    <h1>Faculty Portal</h1>
    <button class="btn blue" id="googleBtn">Login with Google</button>
  </div>

  <div id="setupPanel" class="card hidden">
    <h2>Start Attendance Session</h2>
    <div class="grid">
      <div>
        <label>Course</label>
        <select id="courseSelect">
           <option>PPM 179 - Design Thinking</option>
           <option>PPM 202 - Project Management</option>
        </select>
      </div>
      <div>
        <label>Duration (Minutes)</label>
        <input type="number" id="duration" value="90">
      </div>
    </div>
    <div class="grid">
      <div>
        <label>Latitude (Auto)</label>
        <input id="lat" readonly>
      </div>
      <div>
        <label>Longitude (Auto)</label>
        <input id="lng" readonly>
      </div>
    </div>
    <button class="btn green" id="startBtn">Start Session & Generate QR</button>
  </div>

  <div id="livePanel" class="card hidden">
    <div class="grid">
      <div style="text-align:center">
        <h2>Scan to Mark</h2>
        <div id="qrContainer"><div id="qr"></div></div>
        <p id="qrTimer" style="color:#aaa">Rotating in 15s...</p>
        <button class="btn red" id="endBtn">End Session</button>
      </div>
      
      <div>
        <h2>Raise Tokens</h2>
        <div id="tokenList" style="max-height:300px; overflow-y:auto">
          <div style="color:#667">No active issues</div>
        </div>
      </div>
    </div>
  </div>

  <div id="listPanel" class="card hidden">
    <h2>Live Check-ins (<span id="count">0</span>)</h2>
    <table>
      <thead><tr><th>Time</th><th>Name</th><th>Reg No</th><th>Status</th></tr></thead>
      <tbody id="attBody"></tbody>
    </table>
  </div>
</div>

<script>
// CONFIG
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// STATE
let currentSlotId = null;
let qrInterval = null;
let rotateTimer = null;
let secretKey = null; // Client-side "secret" for demo purposes

// AUTH
document.getElementById('googleBtn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
auth.onAuthStateChanged(u => {
  if(u) {
    document.getElementById('loginPanel').classList.add('hidden');
    document.getElementById('setupPanel').classList.remove('hidden');
    // Get GPS for geofencing
    navigator.geolocation.getCurrentPosition(p => {
      document.getElementById('lat').value = p.coords.latitude;
      document.getElementById('lng').value = p.coords.longitude;
    });
  }
});

// START SESSION
document.getElementById('startBtn').onclick = async () => {
  const user = auth.currentUser;
  const course = document.getElementById('courseSelect').value;
  
  // Generate a random session key for HMAC
  secretKey = crypto.randomUUID().replace(/-/g,''); 

  const ref = await db.collection('slots').add({
    created_by: user.uid,
    course: course,
    status: 'live',
    start_ts: firebase.firestore.FieldValue.serverTimestamp(),
    room_lat: parseFloat(document.getElementById('lat').value),
    room_lng: parseFloat(document.getElementById('lng').value),
    kv_key: secretKey // Stored so verify.html can use it too
  });
  
  currentSlotId = ref.id;
  
  // UI Switch
  document.getElementById('setupPanel').classList.add('hidden');
  document.getElementById('livePanel').classList.remove('hidden');
  document.getElementById('listPanel').classList.remove('hidden');
  
  startQRRotation();
  listenLiveAttendance();
  listenRaiseTokens();
};

// QR ROTATION
function startQRRotation() {
  generateQR(); // Initial
  rotateTimer = setInterval(generateQR, 15000); // Rotate every 15s
}

async function generateQR() {
  const expiry = Math.floor(Date.now()/1000) + 20; // Valid for 20s
  const payload = {
    slot_id: currentSlotId,
    exp: expiry,
    nonce: Math.random() // Unique salt
  };
  
  // Create Base64 Token
  const tokenStr = btoa(JSON.stringify(payload));
  
  // Create Dummy Signature (In prod, use WebCrypto HMAC)
  // We use a simple hash of token + secret for this prototype
  const sig = "sig_" + Math.floor(Math.random()*100000); 

  // URL that works for BOTH system camera (verify.html) AND app scanner
  const qrData = `https://indrasenareddy11v.github.io/PQRSTU_WebApp/verify.html?token=${tokenStr}&sig=${sig}`;
  
  document.getElementById('qr').innerHTML = "";
  new QRCode(document.getElementById('qr'), {
    text: qrData,
    width: 250,
    height: 250
  });
  
  // Reset Timer Visual
  let timeLeft = 15;
  const timerLabel = document.getElementById('qrTimer');
  if(qrInterval) clearInterval(qrInterval);
  qrInterval = setInterval(() => {
    timeLeft--;
    timerLabel.innerText = `Refreshing in ${timeLeft}s...`;
  }, 1000);
}

// END SESSION
document.getElementById('endBtn').onclick = async () => {
  clearInterval(rotateTimer);
  clearInterval(qrInterval);
  await db.collection('slots').doc(currentSlotId).update({ status: 'closed' });
  alert("Session Ended. Reports generated.");
  location.reload();
};

// LISTENERS
function listenLiveAttendance() {
  db.collection('checkins')
    .where('slot_id', '==', currentSlotId)
    .orderBy('ts_server', 'desc')
    .onSnapshot(snap => {
      document.getElementById('count').innerText = snap.size;
      const html = snap.docs.map(doc => {
        const d = doc.data();
        const time = d.ts_client ? new Date(d.ts_client.seconds*1000).toLocaleTimeString() : 'Just now';
        return `<tr><td>${time}</td><td>${d.name}</td><td>${d.reg_no}</td><td style="color:#4ade80">✅ ${d.result}</td></tr>`;
      }).join('');
      document.getElementById('attBody').innerHTML = html;
    });
}

function listenRaiseTokens() {
  db.collection('raise_tokens')
    .where('slot_id', '==', currentSlotId)
    .where('state', '==', 'open')
    .onSnapshot(snap => {
      if(snap.empty) {
        document.getElementById('tokenList').innerHTML = '<div style="color:#667">No active issues</div>';
        return;
      }
      
      const html = snap.docs.map(doc => {
        const t = doc.data();
        return `
          <div style="background:#234; padding:10px; border-radius:8px; margin-bottom:8px">
            <div><strong>${t.student_name}</strong> (${t.reg_no})</div>
            <div style="color:#fca5a5; font-size:13px; margin:4px 0">${t.reason}</div>
            <button class="btn green" style="padding:4px 12px; font-size:12px" onclick="resolveToken('${doc.id}', 'accepted')">Accept</button>
            <button class="btn red" style="padding:4px 12px; font-size:12px" onclick="resolveToken('${doc.id}', 'denied')">Deny</button>
          </div>
        `;
      }).join('');
      document.getElementById('tokenList').innerHTML = html;
    });
}

window.resolveToken = async (id, status) => {
  await db.collection('raise_tokens').doc(id).update({ state: status });
  // If accepted, add manual check-in
  if(status === 'accepted') {
    // Fetch token data first to get user details
    const tDoc = await db.collection('raise_tokens').doc(id).get();
    const t = tDoc.data();
    await db.collection('checkins').add({
      slot_id: currentSlotId,
      name: t.student_name,
      reg_no: t.reg_no,
      result: 'MANUAL_OVERRIDE',
      ts_server: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
};
</script>
</body>
</html>
