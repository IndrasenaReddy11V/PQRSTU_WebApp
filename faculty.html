<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Faculty · PQRSTU</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b1220; --card:rgba(20,27,46,0.75); --text:#eaf0ff; --accent:#3b82f6;}
  body{
    margin:0; font-family:Inter,sans-serif; background:var(--bg); color:var(--text);
    padding:20px; display:flex; justify-content:center;
    background:radial-gradient(at 15% -10%, #2a3566 0%, transparent 60%), linear-gradient(180deg,#0b1220,#141b2e);
  }
  .wrap{max-width:1100px; width:100%;}
  .card{
    background:var(--card); border:1px solid rgba(255,255,255,0.1);
    border-radius:16px; padding:24px; margin-bottom:20px;
    backdrop-filter:blur(10px); box-shadow:0 10px 30px rgba(0,0,0,0.3);
  }
  .hidden{display:none !important}
  h1,h2{margin-top:0; font-weight:800}
  
  /* Inputs */
  input, select{
    width:100%; padding:14px; background:#080c16; border:1px solid #334;
    color:#fff; border-radius:10px; margin:8px 0 16px; font-size:15px;
  }
  .grid {display:grid; grid-template-columns:1fr 1fr; gap:20px}
  
  /* Buttons */
  .btn{
    padding:12px 24px; border-radius:10px; border:none; cursor:pointer;
    font-weight:700; color:#fff; background:#334; transition:0.2s; font-size:15px;
  }
  .btn:hover{transform:translateY(-1px); filter:brightness(1.2)}
  .btn.green{background:linear-gradient(180deg, #16a34a, #15803d)}
  .btn.red{background:linear-gradient(180deg, #ef4444, #b91c1c)}
  .btn.blue{background:linear-gradient(180deg, #3b82f6, #2563eb)}
  
  /* Table */
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th{text-align:left; color:#889; font-size:13px; padding-bottom:12px; border-bottom:1px solid #334}
  td{padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:14px}
  
  #qrContainer{ background:#fff; padding:16px; border-radius:12px; display:inline-block; margin:10px 0; }
  
  /* Toast Notification */
  #toast{position:fixed; top:20px; right:20px; background:#2563eb; padding:16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.5); z-index:9999; animation:slideIn 0.3s ease}
  @keyframes slideIn{from{transform:translateX(100%)}to{transform:none}}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="wrap">
  <div id="loginPanel" class="card">
    <h1>Faculty Portal</h1>
    <p style="color:#aaa; margin-bottom:20px">Sign in to manage attendance sessions.</p>
    <button class="btn blue" id="googleBtn">Login with Google</button>
  </div>

  <div id="setupPanel" class="card hidden">
    <h2>Start Session</h2>
    <div class="grid">
      <div>
        <label>Course</label>
        <select id="courseSelect">
           <option>PPM 179 - Design Thinking</option>
           <option>PPM 202 - Project Management</option>
           <option>MBA - Sustainability Management</option>
        </select>
      </div>
      <div><label>Duration (Min)</label><input type="number" id="duration" value="90"></div>
    </div>
    <div class="grid">
      <div><label>Lat</label><input id="lat" readonly placeholder="Fetching..."></div>
      <div><label>Lng</label><input id="lng" readonly placeholder="Fetching..."></div>
    </div>
    <button class="btn green" id="startBtn">Start Session</button>
  </div>

  <div id="livePanel" class="card hidden">
    <div class="grid">
      <div style="text-align:center">
        <h2>Live QR</h2>
        <div id="qrContainer"><div id="qr"></div></div>
        <p id="qrTimer" style="color:#aaa; font-size:14px">Refreshing...</p>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px">
          <button class="btn red" id="endBtn">End Session</button>
          <button class="btn blue" id="exportBtn">Download Excel</button>
          <button class="btn" id="emailBtn">Email Report</button>
        </div>
      </div>
      
      <div>
        <h2>Raise Tokens <span id="tokenBadge" style="background:#ef4444; padding:2px 8px; border-radius:12px; font-size:12px; display:none">NEW</span></h2>
        <div id="tokenList" style="max-height:350px; overflow-y:auto; padding-right:8px">
          <div style="color:#667">No issues reported yet.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="listPanel" class="card hidden">
    <h2>Checked In: <span id="count">0</span></h2>
    <table>
      <thead><tr><th>Time</th><th>Name</th><th>Reg No</th><th>Status</th></tr></thead>
      <tbody id="attBody"></tbody>
    </table>
  </div>
</div>

<div id="toastContainer"></div>

<script>
// CONFIG
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore(), auth=firebase.auth();

let currentSlotId=null, qrInterval=null, rotateTimer=null, attendees=[];

// AUTH
document.getElementById('googleBtn').onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
auth.onAuthStateChanged(u=>{
  if(u){
    document.getElementById('loginPanel').classList.add('hidden');
    document.getElementById('setupPanel').classList.remove('hidden');
    navigator.geolocation.getCurrentPosition(p=>{
      document.getElementById('lat').value=p.coords.latitude;
      document.getElementById('lng').value=p.coords.longitude;
    });
  }
});

// START
document.getElementById('startBtn').onclick=async()=>{
  const c=document.getElementById('courseSelect').value;
  const ref=await db.collection('slots').add({
    created_by: auth.currentUser.uid, course: c, status: 'live',
    start_ts: firebase.firestore.FieldValue.serverTimestamp(),
    room_lat: parseFloat(document.getElementById('lat').value),
    room_lng: parseFloat(document.getElementById('lng').value)
  });
  currentSlotId=ref.id;
  
  document.getElementById('setupPanel').classList.add('hidden');
  document.getElementById('livePanel').classList.remove('hidden');
  document.getElementById('listPanel').classList.remove('hidden');
  
  startQR(); listenAtt(); listenTokens();
};

// QR LOGIC
function startQR(){ generateQR(); rotateTimer=setInterval(generateQR,15000); }
function generateQR(){
  const payload={ slot_id: currentSlotId, exp: Math.floor(Date.now()/1000)+20, nonce: Math.random() };
  // Simple Base64 token for robustness
  const token=btoa(JSON.stringify(payload));
  // URL that works for System Camera AND App Scanner
  const url=`https://indrasenareddy11v.github.io/PQRSTU_WebApp/verify.html?token=${token}`;
  
  document.getElementById('qr').innerHTML='';
  new QRCode(document.getElementById('qr'), {text:url, width:220, height:220});
  
  let t=15; const lbl=document.getElementById('qrTimer');
  if(qrInterval) clearInterval(qrInterval);
  qrInterval=setInterval(()=>{ t--; lbl.textContent=`New QR in ${t}s`; },1000);
}

// END SESSION
document.getElementById('endBtn').onclick=async()=>{
  clearInterval(rotateTimer); clearInterval(qrInterval);
  await db.collection('slots').doc(currentSlotId).update({status:'closed'});
  alert('Session Closed.'); location.reload();
};

// EXPORT EXCEL
document.getElementById('exportBtn').onclick=()=>{
  if(attendees.length===0) return alert('No attendance data');
  const ws = XLSX.utils.json_to_sheet(attendees);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Attendance");
  XLSX.writeFile(wb, "PQRSTU_Attendance.xlsx");
};

// EMAIL (Simple mailto)
document.getElementById('emailBtn').onclick=()=>{
  const subject = "Attendance Report";
  const body = "Please attach the downloaded Excel file.";
  window.open(`mailto:?subject=${subject}&body=${body}`);
};

// LISTEN ATTENDANCE
function listenAtt(){
  db.collection('checkins').where('slot_id','==',currentSlotId).orderBy('ts_server','desc')
    .onSnapshot(snap=>{
      attendees = snap.docs.map(d=>{
        const data=d.data();
        return {
          Time: data.ts_client ? new Date(data.ts_client.seconds*1000).toLocaleTimeString() : '',
          Name: data.name, RegNo: data.reg_no, Status: data.result
        };
      });
      document.getElementById('count').textContent=snap.size;
      document.getElementById('attBody').innerHTML = attendees.map(row=>
        `<tr><td>${row.Time}</td><td>${row.Name}</td><td>${row.RegNo}</td><td style="color:#4ade80">✅ ${row.Status}</td></tr>`
      ).join('');
    });
}

// LISTEN TOKENS (Fixed Notification)
function listenTokens(){
  db.collection('raise_tokens').where('slot_id','==',currentSlotId).where('state','==','open')
    .onSnapshot(snap=>{
      if(!snap.empty) showToast(`⚠️ ${snap.size} Open Token(s)!`);
      
      const html = snap.docs.map(d=>{
        const t=d.data();
        return `<div style="background:#234; padding:12px; border-radius:8px; margin-bottom:10px">
          <strong>${t.student_name}</strong> (${t.reg_no})
          <div style="color:#fca5a5; font-size:13px; margin:4px 0">${t.reason}</div>
          <button class="btn green" style="padding:4px 10px; font-size:12px" onclick="resolve('${d.id}','accepted','${t.student_name}','${t.reg_no}')">Accept</button>
          <button class="btn red" style="padding:4px 10px; font-size:12px" onclick="resolve('${d.id}','denied')">Deny</button>
        </div>`;
      }).join('');
      document.getElementById('tokenList').innerHTML = html || '<div style="color:#667">No issues.</div>';
    });
}

window.resolve=async(id, status, name, reg)=>{
  await db.collection('raise_tokens').doc(id).update({state:status});
  if(status==='accepted'){
    await db.collection('checkins').add({
      slot_id: currentSlotId, name: name, reg_no: reg, result: 'MANUAL',
      ts_server: firebase.firestore.FieldValue.serverTimestamp(), ts_client: new Date()
    });
  }
};

function showToast(msg){
  const t=document.createElement('div'); t.id='toast'; t.textContent=msg;
  document.getElementById('toastContainer').appendChild(t);
  setTimeout(()=>t.remove(), 4000);
}
</script>
</body>
</html>
