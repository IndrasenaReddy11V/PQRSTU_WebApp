<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Faculty Â· PQRSTU</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#111; --card:#222; --text:#fff;}
  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);padding:20px;display:flex;justify-content:center}
  .wrap{max-width:800px;width:100%}
  .card{background:var(--card);border:1px solid #333;border-radius:16px;padding:20px;margin-bottom:20px;}
  .hidden{display:none}
  .btn{padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;color:#fff;background:#333;margin-right:10px}
  .btn.green{background:#16a34a} .btn.red{background:#ef4444}
  #qrContainer{background:#fff;padding:20px;display:inline-block;margin:15px 0}
  select{padding:10px; width:100%; margin-bottom:10px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
<div class="wrap">
  
  <div id="setupPanel" class="card">
    <h1>Faculty Panel</h1>
    <button class="btn" onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())">Login</button>
    <div id="authStatus" style="margin-top:10px;color:#888">Not signed in</div>
    
    <hr style="border:0;border-top:1px solid #333;margin:20px 0">
    
    <select id="course">
       <option>PPM 179 - Design Thinking</option>
       <option>Test Course</option>
    </select>
    <button class="btn green" id="startBtn" disabled>Start Session</button>
  </div>

  <div id="livePanel" class="card hidden">
    <div style="text-align:center">
      <h2>Scan to Mark</h2>
      <div id="qrContainer"><div id="qr"></div></div>
      <p id="qrTimer">Refreshing...</p>
      <button class="btn red" id="endBtn">End Session</button>
    </div>
    <hr style="border:0;border-top:1px solid #333;margin:20px 0">
    <h3>Raise Tokens</h3>
    <div id="tokenList">Waiting...</div>
  </div>

  <div id="listPanel" class="card hidden">
    <h3>Attendees: <span id="count">0</span></h3>
    <div id="attList" style="max-height:200px;overflow-y:auto"></div>
  </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore(), auth=firebase.auth();

let slotId=null;

auth.onAuthStateChanged(u=>{
  if(u){
    document.getElementById('authStatus').innerText = "Signed in as " + u.email;
    document.getElementById('startBtn').disabled = false;
  }
});

document.getElementById('startBtn').onclick=async()=>{
  const ref = await db.collection('slots').add({
    created_by: auth.currentUser.uid,
    course: document.getElementById('course').value,
    status: 'live',
    created_at: new Date()
  });
  slotId = ref.id;
  
  document.getElementById('setupPanel').classList.add('hidden');
  document.getElementById('livePanel').classList.remove('hidden');
  document.getElementById('listPanel').classList.remove('hidden');
  
  startQR();
  listenData();
}

function startQR(){
  genQR();
  setInterval(genQR, 10000);
}

function genQR(){
  // RAW FORMAT: SLOTID|EXPIRY
  const exp = Math.floor(Date.now()/1000) + 15; // 15s validity
  const rawData = `${slotId}|${exp}`;
  
  document.getElementById('qr').innerHTML = "";
  // Level L = Biggest Blocks
  new QRCode(document.getElementById('qr'), {
    text: rawData,
    width: 250,
    height: 250,
    correctLevel: QRCode.CorrectLevel.L
  });
  document.getElementById('qrTimer').innerText = "Valid until " + new Date(exp*1000).toLocaleTimeString();
}

function listenData(){
  // Attendees
  db.collection('checkins').where('slot_id','==',slotId).onSnapshot(s=>{
    document.getElementById('count').innerText = s.size;
    document.getElementById('attList').innerHTML = s.docs.map(d=>
      `<div>${d.data().name} (${d.data().reg_no})</div>`
    ).join('');
  });
  
  // Tokens
  db.collection('raise_tokens').where('slot_id','==',slotId).onSnapshot(s=>{
    document.getElementById('tokenList').innerHTML = s.docs.map(d=>{
      const t = d.data();
      return `<div style="background:#333;padding:10px;margin:5px 0">
        <b>${t.student_name}</b>: ${t.reason} (${t.state})
        <br><button onclick="reply('${d.id}','accepted')">Accept</button>
        <button onclick="reply('${d.id}','denied')">Deny</button>
      </div>`;
    }).join('');
  });
}

window.reply = (id, state) => db.collection('raise_tokens').doc(id).update({state});

document.getElementById('endBtn').onclick = async () => {
  await db.collection('slots').doc(slotId).update({status:'closed'});
  location.reload();
}
</script>
</body>
</html>
