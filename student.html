<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Student ¬∑ PQRSTU</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg1:#0b1220;--bg2:#141b2e;--text:#eaf0ff;--muted:#b8c0d9;--stroke:rgba(255,255,255,.12);--card:rgba(16,23,41,.62)}
  *{box-sizing:border-box}html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,Arial,Segoe UI,sans-serif;color:var(--text);
    background:
      radial-gradient(1200px 600px at 20% -10%, #2a3566 0%, transparent 60%),
      radial-gradient(1000px 700px at 100% 0%, #5b2231 0%, transparent 60%),
      linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);
    padding:20px;display:flex;justify-content:center
  }
  .wrap{width:min(960px,100%)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:18px;margin:18px 0;
        box-shadow:inset 0 1px 0 rgba(255,255,255,.05),0 18px 50px rgba(0,0,0,.24);
        opacity:0;transform:translateY(8px);animation:up .55s .1s forwards}
  @keyframes up{to{opacity:1;transform:none}}
  .muted{color:var(--muted)}
  .loginbox{max-width:480px;margin-inline:auto;text-align:center}
  .title{font-weight:800;font-size:26px;margin:4px 0}.subtitle{color:var(--muted);margin:0 0 12px}
  .sso{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .sbtn{display:flex;align-items:center;gap:12px;justify-content:center;width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));color:#fff;font-weight:800;cursor:pointer}
  .ico{width:18px;height:18px;display:inline-block}
  .ico.g{background:url('https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg') center/contain no-repeat}
  .ico.ms{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 480 480'><rect x='24' y='24' width='204' height='204' fill='%23f25022'/><rect x='252' y='24' width='204' height='204' fill='%237eb900'/><rect x='24' y='252' width='204' height='204' fill='%2300a4ef'/><rect x='252' y='252' width='204' height='204' fill='%23ffb900'/></svg>");background-position:center;background-repeat:no-repeat;background-size:contain}
  .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}@media (max-width:860px){.grid{grid-template-columns:1fr}}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #304;background:#0f1630;color:#eaf0ff}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg, rgba(61,109,242,.3), rgba(61,109,242,.15));color:#fff;font-weight:800;cursor:pointer}
  .btn.alt{background:linear-gradient(180deg, rgba(155,28,37,.45), rgba(155,28,37,.2))}
  #scanner{border-radius:12px;overflow:hidden;background:#0f1630;border:1px dashed rgba(255,255,255,.2)}
  .success{position:fixed;inset:0;background:rgba(5,20,5,.85);display:none;align-items:center;justify-content:center;z-index:9999}
  .success>div{background:#0a7a33;border:2px solid #12d16a;color:#fff;padding:24px 28px;border-radius:16px;font-size:20px;font-weight:800;box-shadow:0 24px 80px rgba(0,0,0,.5);text-align:center;animation:pop .5s ease}
  @keyframes pop{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div class="wrap">

  <!-- Login -->
  <div id="authPanel" class="card loginbox">
    <div class="title">Welcome to PQRSTU</div>
    <div class="subtitle">Log in to your account and start marking your attendance</div>
    <div class="sso">
      <button class="sbtn" id="googleBtn"><span class="ico g"></span> Sign in with Google</button>
      <button class="sbtn" id="microsoftBtn"><span class="ico ms"></span> Sign in with Microsoft</button>
    </div>
    <div id="authMsg" class="muted" style="margin-top:12px">Not signed in</div>
  </div>

  <!-- Profile -->
  <div id="signupPanel" class="card" style="display:none">
    <h2>Complete your profile (one-time)</h2>
    <div class="grid">
      <div><label>Full Name</label><input id="name" placeholder="As per SSC"></div>
      <div><label>Department</label><select id="dept"><option>MBA in Sustainability Management</option></select></div>
      <div><label>Registration No (2400249MBS)</label><input id="reg" maxlength="10"></div>
      <div><label>Date of Birth (27Aug2002)</label><input id="dob" maxlength="9"></div>
    </div>
    <button class="btn" id="signupBtn" style="margin-top:10px">Submit</button>
    <div id="signupMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- Home -->
  <div id="homePanel" class="card" style="display:none">
    <h2 id="hi">Hi Student</h2>
    <button class="btn" id="goMark" style="margin-top:12px;background:linear-gradient(180deg, rgba(59,130,246,.45), rgba(59,130,246,.25))">Mark Your Attendance</button>
    <div id="liveHint" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- Attendance -->
  <div id="attPanel" class="card" style="display:none">
    <h2>Attendance ¬∑ Verify & Scan</h2>
    <div class="grid">
      <div><label>Registration No</label><input id="areg" maxlength="10"/></div>
      <div><label>Password (DOB)</label><input id="apass" maxlength="9"/></div>
    </div>
    <h3 style="margin:14px 0 8px">Scan live dynamic QR</h3>
    <div id="scanner" style="width:100%;max-width:420px"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="startScan">Start Camera</button>
      <button class="btn alt" id="stopScan">Stop Camera</button>
    </div>
    <div id="scanMsg" class="muted" style="margin-top:8px">Scanner idle</div>
    <button class="btn" id="markBtn" style="margin-top:10px">Submit Attendance</button>
  </div>
</div>

<div class="success" id="successOverlay"><div>üéâ Congrats! Your attendance has been marked successfully</div></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Html5Qrcode Primary & Backup -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/html5-qrcode.min.js" onerror="this.onerror=null;this.src='https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js'"></script>

<script>
/* Wait for QR library */
async function waitForHtml5Qrcode(){
  for(let i=0;i<40;i++){ // wait up to 4 seconds
    if(window.Html5Qrcode) return true;
    await new Promise(r=>setTimeout(r,100));
  }
  alert('‚ö†Ô∏è QR Scanner library failed to load. Please check your internet and refresh.');
  return false;
}
</script>

<script>
/* Firebase config */
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();

const qs=id=>document.getElementById(id);
const show=(id,on=true)=>qs(id).style.display=on?'block':'none';

/* --- QR scanner section --- */
let html5Qr=null, parsed=null;
function setScanMsg(msg){qs('scanMsg').textContent=msg;}

qs('startScan').onclick=async()=>{
  const ok=await waitForHtml5Qrcode();
  if(!ok) return;
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    stream.getTracks().forEach(t=>t.stop());
    html5Qr=new Html5Qrcode("scanner");
    const cams=await Html5Qrcode.getCameras();
    const camId=(cams.find(c=>/back|rear|environment/i.test(c.label))||cams[0]).id;
    await html5Qr.start({deviceId:{exact:camId}},{fps:10,qrbox:{width:250,height:250}},text=>{
      if(!text.startsWith("att://v1.")) return setScanMsg("Non-attendance QR detected");
      try{
        const part=text.split('.')[1];
        parsed=JSON.parse(atob(part));
        setScanMsg("‚úÖ QR recognized ¬∑ slot "+parsed.slot_id);
      }catch{setScanMsg("Invalid QR format");parsed=null;}
    });
    setScanMsg("Camera started. Aim at the live QR code.");
  }catch(e){setScanMsg("Camera failed: "+e.message);}
};
qs('stopScan').onclick=async()=>{if(html5Qr){await html5Qr.stop();html5Qr.clear();setScanMsg("Scanner stopped");}}
</script>
</body>
</html>
