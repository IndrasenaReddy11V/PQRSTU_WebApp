<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Student ¬∑ PQRSTU</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0a0f1f;--bg2:#0e1530;--ink:#eaf0ff;--muted:#b9c3df;--stroke:rgba(255,255,255,.12);
    --card:rgba(16,23,41,.90);--green:#16a34a;--red:#ef4444;--blue:#3b82f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,sans-serif; color:var(--ink);
    background:
      radial-gradient(1200px 600px at 20% -10%, #2a3566 0%, transparent 60%),
      radial-gradient(1000px 700px at 100% 0%, #5b2231 0%, transparent 60%),
      linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    padding:20px; display:flex; justify-content:center; overflow-x:hidden
  }
  .wrap{ width:min(500px,100%); position:relative; z-index:1 }
  .card{
    background:var(--card); border:1px solid var(--stroke); border-radius:18px;
    padding:24px; margin-bottom:20px; box-shadow:0 18px 50px rgba(0,0,0,.4);
    backdrop-filter: blur(12px); animation:fadeIn .5s ease;
  }
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  
  .hidden{display:none !important}
  h1{margin:0 0 8px; font-size:28px; font-weight:800; background:linear-gradient(90deg,#fff,#ccc); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  h2{margin:0 0 16px; font-size:20px}
  .muted{color:var(--muted); font-size:14px; line-height:1.5}
  
  /* Inputs & Buttons */
  input,select{
    width:100%; padding:14px; border-radius:12px; border:1px solid #304060; 
    background:#0f1630; color:#fff; margin-bottom:12px; font-size:15px;
  }
  input:focus{outline:none; border-color:var(--blue); box-shadow:0 0 0 3px rgba(59,130,246,.2)}
  
  .btn{
    width:100%; padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
    color:#fff; font-weight:700; font-size:16px; cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.2); margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:10px;
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--blue)}
  .btn.green{background:var(--green)}
  .btn.red{background:var(--red)}

  /* Scanner Box */
  #scannerContainer{
    position:relative; border-radius:16px; overflow:hidden; 
    border:2px dashed rgba(255,255,255,.3); background:#000; min-height:320px;
  }
  #scanner video { object-fit: cover; width:100%; height:100%; }
  
  /* Status Overlays */
  .overlay{position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.9); opacity:0; pointer-events:none; transition:opacity .3s}
  .overlay.active{opacity:1; pointer-events:all}
  .msg-box{background:#111; padding:30px; border-radius:20px; text-align:center; max-width:320px; border:1px solid #333}
  .big-icon{font-size:48px; display:block; margin-bottom:16px}
</style>
</head>
<body>

<div id="successOverlay" class="overlay">
  <div class="msg-box">
    <span class="big-icon">‚úÖ</span>
    <h3>Attendance Marked!</h3>
    <p class="muted">Your presence has been recorded successfully.</p>
    <button class="btn green" onclick="location.reload()">Done</button>
  </div>
</div>

<div class="wrap">
  <div id="authPanel" class="card">
    <div style="text-align:center; padding:20px 0">
      <h1>PQRSTU</h1>
      <p class="muted" style="margin-bottom:30px">Log in to mark your attendance</p>
      <button class="btn" id="googleBtn" style="background:#fff; color:#000">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Sign in with Google
      </button>
      <button class="btn" id="microsoftBtn" style="background:#2f2f2f">
        <span style="font-size:18px">‚ùñ</span> Sign in with Microsoft
      </button>
      <div id="authMsg" class="muted" style="margin-top:16px; font-size:12px">Secure Authentication</div>
    </div>
  </div>

  <div id="profilePanel" class="card hidden">
    <h2>Complete Profile</h2>
    <p class="muted">We need your details for the attendance record.</p>
    <input id="pName" placeholder="Full Name">
    <input id="pReg" placeholder="Registration No (e.g. 2400249MBS)" maxlength="10" style="text-transform:uppercase">
    <input id="pDob" placeholder="DOB (e.g. 15Aug1999)">
    <button class="btn primary" id="saveProfileBtn">Save & Continue</button>
  </div>

  <div id="homePanel" class="card hidden">
    <h2 id="welcomeText" style="margin-bottom:6px">Hello Student</h2>
    <p class="muted" style="margin-bottom:20px">Ready to mark attendance?</p>
    
    <div style="background:rgba(255,255,255,.06); padding:16px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.1)">
      <div id="liveIndicator" style="font-weight:700; color:var(--red); display:flex; align-items:center; gap:8px">
        <span>‚óè</span> <span id="liveText">No Session Active</span>
      </div>
      <div id="sessionInfo" class="muted" style="margin-top:4px; font-size:13px">Waiting for faculty...</div>
    </div>

    <button id="scanActionBtn" class="btn green" disabled>üì∑ Scan QR Code</button>
    
    <div style="margin-top:24px; padding-top:20px; border-top:1px solid var(--stroke)">
      <h3 style="font-size:16px; margin:0 0 10px">Having issues?</h3>
      <input id="rtReason" placeholder="Describe issue (e.g. Camera broken)">
      <button id="raiseBtn" class="btn red">Raise Token</button>
      <div id="rtStatus" class="muted" style="margin-top:8px; font-size:13px"></div>
    </div>
  </div>

  <div id="scanPanel" class="card hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
      <h2>Scan QR</h2>
      <button class="btn" style="width:auto; padding:6px 14px; margin:0; font-size:13px" onclick="stopScanner()">Cancel</button>
    </div>
    <div id="scannerContainer"><div id="scanner"></div></div>
    <p id="scanFeedback" style="text-align:center; margin-top:16px; color:var(--blue)">Initializing camera...</p>
    
    <div style="margin-top:20px; padding-top:16px; border-top:1px solid var(--stroke)">
      <p class="muted" style="font-size:12px">VERIFY IDENTITY</p>
      <input id="vPass" placeholder="Enter your DOB to confirm" style="margin-bottom:8px">
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
// CONFIG
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();

// STATE
let user=null, profile=null, currentSlot=null, html5QrCode=null, lastGeo=null;

// NAVIGATION
function show(id){ ['authPanel','profilePanel','homePanel','scanPanel'].forEach(p=>document.getElementById(p).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }

// 1. AUTH LOGIC
const login=p=>auth.signInWithPopup(p).catch(e=>alert(e.message));
document.getElementById('googleBtn').onclick=()=>login(new firebase.auth.GoogleAuthProvider());
document.getElementById('microsoftBtn').onclick=()=>{const p=new firebase.auth.OAuthProvider('microsoft.com'); login(p);};

auth.onAuthStateChanged(async u=>{
  if(u){
    user=u; document.getElementById('authMsg').textContent='Signed in as '+u.email;
    const d=await db.collection('users').doc(u.uid).get();
    if(d.exists){ profile=d.data(); document.getElementById('welcomeText').innerText='Hi, '+profile.name; show('homePanel'); listenLive(); }
    else{ show('profilePanel'); }
  }else{ show('authPanel'); }
});

// 2. PROFILE SAVE
document.getElementById('saveProfileBtn').onclick=async()=>{
  const name=document.getElementById('pName').value.trim(), reg=document.getElementById('pReg').value.trim(), dob=document.getElementById('pDob').value.trim();
  if(!name||!reg||!dob) return alert('Fill all fields');
  await db.collection('users').doc(user.uid).set({uid:user.uid,email:user.email,name,reg_no:reg,dob,created_at:new Date()});
  location.reload();
};

// 3. LISTEN FOR SESSIONS (Fixes "Raise Token" bug)
function listenLive(){
  db.collection('slots').where('status','==','live').onSnapshot(snap=>{
    if(!snap.empty){
      const d=snap.docs[0]; currentSlot={id:d.id, ...d.data()};
      document.getElementById('liveText').textContent='Attendance is LIVE';
      document.getElementById('liveIndicator').style.color='var(--green)';
      document.getElementById('sessionInfo').textContent=`${currentSlot.course}`;
      document.getElementById('scanActionBtn').disabled=false;
    }else{
      currentSlot=null;
      document.getElementById('liveText').textContent='No Session Active';
      document.getElementById('liveIndicator').style.color='var(--red)';
      document.getElementById('sessionInfo').textContent='Waiting for faculty...';
      document.getElementById('scanActionBtn').disabled=true;
    }
  });
}

// 4. SCANNER (Fixes "Not Scanning" bug)
document.getElementById('scanActionBtn').onclick=()=>{
  if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>lastGeo=p.coords);
  show('scanPanel');
  startScanner();
};

async function startScanner(){
  try{
    html5QrCode = new Html5Qrcode("scanner");
    await html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:250}, onScan, err=>{});
    document.getElementById('scanFeedback').textContent='Point camera at QR Code';
  }catch(e){
    document.getElementById('scanFeedback').textContent='Camera Error: '+e;
    try{ await html5QrCode.start({facingMode:"user"}, {fps:10, qrbox:250}, onScan, err=>{}); }catch(e2){}
  }
}
function stopScanner(){ if(html5QrCode) html5QrCode.stop().then(()=>html5QrCode.clear()); show('homePanel'); }

async function onScan(txt){
  if(html5QrCode) html5QrCode.stop();
  document.getElementById('scanFeedback').textContent='Processing...';
  
  // Verify Identity
  const pass=document.getElementById('vPass').value.trim();
  if(pass !== profile.dob){ alert(`Enter DOB (${profile.dob}) to confirm identity!`); stopScanner(); return; }

  try{
    // Robust Parsing (Handle URL or JSON)
    let jsonStr = txt;
    if(txt.includes('token=')){
      const url = new URL(txt.startsWith('http')?txt:'https://a.com/'+txt);
      jsonStr = atob(url.searchParams.get('token'));
    }else if(!txt.startsWith('{')){
      // Try base64 decoding raw string just in case
      try{ jsonStr = atob(txt); }catch(e){}
    }

    const payload = JSON.parse(jsonStr);
    
    if(payload.slot_id !== currentSlot.id) throw "QR is from a different session!";
    if(payload.exp < Date.now()/1000) throw "QR Expired! Scan the new one.";

    await db.collection('checkins').add({
      slot_id: currentSlot.id, student_uid: user.uid,
      name: profile.name, reg_no: profile.reg_no, email: user.email,
      ts_server: firebase.firestore.FieldValue.serverTimestamp(),
      ts_client: new Date(), result: 'OK', method: 'APP_SCAN',
      lat: lastGeo?.latitude||null, lng: lastGeo?.longitude||null
    });

    document.getElementById('successOverlay').classList.add('active');
  }catch(e){
    alert('Failed: '+(e.message||e)); stopScanner();
  }
}

// 5. RAISE TOKEN (Fixed)
document.getElementById('raiseBtn').onclick=async()=>{
  const r=document.getElementById('rtReason').value.trim();
  const box=document.getElementById('rtStatus');
  if(!currentSlot){ box.textContent='‚ùå No live session.'; return; }
  if(!r){ box.textContent='‚ö†Ô∏è Enter a reason.'; return; }
  
  box.textContent='Sending...';
  await db.collection('raise_tokens').add({
    slot_id: currentSlot.id, student_uid: user.uid,
    student_name: profile.name, reg_no: profile.reg_no, email: user.email,
    reason: r, state: 'open', created_at: firebase.firestore.FieldValue.serverTimestamp()
  });
  box.textContent='‚úÖ Token Sent! Waiting for faculty...';
  
  // Listen for reply
  db.collection('raise_tokens').where('slot_id','==',currentSlot.id).where('student_uid','==',user.uid)
    .onSnapshot(s=>{
      s.docChanges().forEach(c=>{
        if(c.type==='modified'){
          const st=c.doc.data().state;
          if(st==='accepted') alert('Faculty APPROVED your token!');
          if(st==='denied') alert('Faculty DENIED your token.');
        }
      });
    });
};
</script>
</body>
</html>
