<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<title>Student ¬∑ PQRSTU</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0a0f1f;--bg2:#0e1530;--ink:#eaf0ff;--muted:#b9c3df;--stroke:rgba(255,255,255,.12);
    --card:rgba(16,23,41,.85);--green:#16a34a;--red:#ef4444;--blue:#3b82f6;--amber:#f59e0b
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,sans-serif; color:var(--ink);
    background: radial-gradient(at 20% -10%, #2a3566 0%, transparent 60%),
                radial-gradient(at 100% 0%, #5b2231 0%, transparent 60%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
    padding:20px; display:flex; justify-content:center; overflow-x:hidden
  }
  .wrap{ width:min(980px,100%); z-index:1 }
  .card{
    background:var(--card); border:1px solid var(--stroke); border-radius:18px;
    padding:20px; margin:18px 0; box-shadow:0 18px 50px rgba(0,0,0,.3);
    backdrop-filter: blur(10px); animation:up .5s ease forwards;
  }
  @keyframes up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  
  .hidden{display:none !important}
  h2{margin:0 0 12px; font-size:20px}
  .muted{color:var(--muted); font-size:14px}
  
  /* Inputs & Buttons */
  input,select{
    width:100%; padding:14px; border-radius:12px; border:1px solid #304060; 
    background:#0f1630; color:#fff; margin-bottom:12px; font-size:16px;
  }
  input:focus{outline:none; border-color:var(--blue); box-shadow:0 0 0 3px rgba(59,130,246,.2)}
  
  .btn{
    width:100%; padding:14px; border-radius:12px; border:none;
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
    color:#fff; font-weight:700; font-size:16px; cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.2); transition:transform .1s;
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--blue)}
  .btn.green{background:var(--green)}
  .btn.red{background:var(--red)}

  /* Scanner Specifics */
  #scannerContainer{
    position:relative; border-radius:16px; overflow:hidden; 
    border:2px dashed rgba(255,255,255,.2); background:#000; min-height:300px;
  }
  #scanner video { object-fit: cover; width:100%; height:100%; }
  
  /* Status Overlays */
  .overlay{position:fixed; inset:0; z-index:999; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.9); opacity:0; pointer-events:none; transition:opacity .3s}
  .overlay.active{opacity:1; pointer-events:all}
  .msg-box{background:#111; padding:30px; border-radius:20px; text-align:center; max-width:320px; border:1px solid #333}
  .big-icon{font-size:48px; display:block; margin-bottom:16px}

  /* Toast */
  #toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; padding:12px 24px; border-radius:30px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .3s; white-space:nowrap; z-index:1000}
</style>
</head>
<body>

<div id="toast"></div>

<div id="successOverlay" class="overlay">
  <div class="msg-box">
    <span class="big-icon">‚úÖ</span>
    <h3>Attendance Marked!</h3>
    <p class="muted">Your presence has been recorded successfully.</p>
    <button class="btn" onclick="location.reload()">Done</button>
  </div>
</div>

<div class="wrap">
  <div id="authPanel" class="card" style="text-align:center">
    <h1 style="margin-bottom:8px">PQRSTU</h1>
    <p class="muted">Student Attendance Portal</p>
    <div style="margin:24px 0">
      <button class="btn" id="googleBtn" style="background:#fff;color:#000;margin-bottom:12px">
        <span style="margin-right:8px">G</span> Sign in with Google
      </button>
      <button class="btn" id="microsoftBtn" style="background:#2f2f2f">
        <span style="margin-right:8px">‚ùñ</span> Sign in with Microsoft
      </button>
    </div>
    <div id="authStatus" class="muted">Not signed in</div>
  </div>

  <div id="profilePanel" class="card hidden">
    <h2>One-time Setup</h2>
    <p class="muted">Please update your details to continue.</p>
    <input id="pName" placeholder="Full Name">
    <input id="pReg" placeholder="Registration No (e.g. 2400249MBS)" maxlength="10">
    <input id="pDob" placeholder="DOB (e.g. 15Aug1999)">
    <select id="pDept"><option>MBA in Sustainability Management</option></select>
    <button class="btn primary" id="saveProfileBtn">Save & Continue</button>
  </div>

  <div id="homePanel" class="card hidden">
    <h2 id="welcomeText">Hello Student</h2>
    
    <div id="statusBox" style="background:rgba(255,255,255,.05); padding:16px; border-radius:12px; margin-bottom:16px">
      <div id="liveIndicator" style="color:var(--amber); font-weight:700">‚óè Checking for live sessions...</div>
      <div id="sessionInfo" class="muted" style="margin-top:4px; font-size:13px">Please wait...</div>
    </div>

    <button id="scanActionBtn" class="btn green" disabled>üì∑ Scan QR Code</button>
    
    <hr style="border:0; border-top:1px solid var(--stroke); margin:20px 0">

    <h3>Having trouble?</h3>
    <input id="rtReason" placeholder="Describe your issue (e.g. Camera not working)">
    <button id="raiseBtn" class="btn red">Raise Token</button>
    <div id="rtStatus" class="muted" style="margin-top:8px"></div>
  </div>

  <div id="scanPanel" class="card hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
      <h2>Scan QR</h2>
      <button class="btn" style="width:auto; padding:8px 16px" onclick="stopScanner()">Close</button>
    </div>
    <div id="scannerContainer">
      <div id="scanner"></div>
    </div>
    <p id="scanFeedback" style="text-align:center; margin-top:12px; color:var(--blue)">Camera initializing...</p>
    
    <div style="margin-top:20px; border-top:1px solid var(--stroke); padding-top:20px">
      <p class="muted">Verify Identity to confirm:</p>
      <input id="vReg" placeholder="Reg No (Auto-filled)" disabled>
      <input id="vPass" placeholder="Enter DOB (e.g. 15Aug1999)">
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
// 1. CONFIGURATION
const firebaseConfig={apiKey:"AIzaSyDmsPg0iw05Ih2N2LEPcVAd-vmhDl1nm5U",authDomain:"project-qr-eceae.firebaseapp.com",projectId:"project-qr-eceae",storageBucket:"project-qr-eceae.firebasestorage.app",messagingSenderId:"527248340371",appId:"1:527248340371:web:870ca9bed83372e390e466"};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// 2. STATE MANAGEMENT
let user = null;
let profile = null;
let currentSlot = null;
let html5QrCode = null;
let lastGeo = null;

// 3. AUTHENTICATION
const providerLogin = async (provider) => {
  try {
    await auth.signInWithPopup(provider);
  } catch (e) {
    if (e.code === 'auth/popup-blocked') auth.signInWithRedirect(provider);
    else alert(e.message);
  }
};

document.getElementById('googleBtn').onclick = () => providerLogin(new firebase.auth.GoogleAuthProvider());
document.getElementById('microsoftBtn').onclick = () => providerLogin(new firebase.auth.OAuthProvider('microsoft.com'));

auth.onAuthStateChanged(async (u) => {
  if (u) {
    user = u;
    document.getElementById('authStatus').innerText = `Signed in as ${u.email}`;
    await checkProfile();
  } else {
    showPanel('authPanel');
  }
});

async function checkProfile() {
  const doc = await db.collection('users').doc(user.uid).get();
  if (doc.exists) {
    profile = doc.data();
    document.getElementById('welcomeText').innerText = `Hi, ${profile.name}`;
    document.getElementById('vReg').value = profile.reg_no;
    showPanel('homePanel');
    listenToSessions(); // Start Real-time Listener
  } else {
    showPanel('profilePanel');
  }
}

document.getElementById('saveProfileBtn').onclick = async () => {
  const name = document.getElementById('pName').value.trim();
  const reg = document.getElementById('pReg').value.trim();
  const dob = document.getElementById('pDob').value.trim();
  
  if(!name || !reg || !dob) return alert("All fields are required");
  
  await db.collection('users').doc(user.uid).set({
    uid: user.uid, email: user.email, name, reg_no: reg, dob,
    created_at: firebase.firestore.FieldValue.serverTimestamp()
  });
  checkProfile();
};

// 4. REAL-TIME SESSION LISTENER (Fixes Raise Token Bug)
function listenToSessions() {
  db.collection('slots').where('status', '==', 'live')
    .onSnapshot((snapshot) => {
      if (!snapshot.empty) {
        // We have a live session!
        const doc = snapshot.docs[0];
        currentSlot = { id: doc.id, ...doc.data() };
        
        document.getElementById('liveIndicator').innerHTML = `üü¢ <b>Attendance is LIVE</b>`;
        document.getElementById('liveIndicator').style.color = '#22c55e'; // Green
        document.getElementById('sessionInfo').innerText = `${currentSlot.course} (${currentSlot.remarks || ''})`;
        document.getElementById('scanActionBtn').disabled = false;
        document.getElementById('scanActionBtn').innerText = "üì∑ Scan QR Code";
      } else {
        // No live session
        currentSlot = null;
        document.getElementById('liveIndicator').innerHTML = `üî¥ <b>No Active Session</b>`;
        document.getElementById('liveIndicator').style.color = '#ef4444'; // Red
        document.getElementById('sessionInfo').innerText = "Waiting for faculty to start...";
        document.getElementById('scanActionBtn').disabled = true;
        document.getElementById('scanActionBtn').innerText = "Wait for Session";
      }
    });
}

// 5. SCANNER LOGIC (Fixes Camera & Reflection Bug)
function showPanel(id) {
  ['authPanel','profilePanel','homePanel','scanPanel'].forEach(p => document.getElementById(p).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

document.getElementById('scanActionBtn').onclick = () => {
  // Capture GPS immediately
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      p => { lastGeo = p.coords; }, 
      e => { console.warn("GPS Fail", e); alert("Please enable GPS for attendance."); }
    );
  }
  showPanel('scanPanel');
  startScanner();
};

async function startScanner() {
  try {
    html5QrCode = new Html5Qrcode("scanner");
    // Config specifically for mobile rear camera
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    
    // Try environment first, fallback to user
    await html5QrCode.start(
      { facingMode: "environment" }, 
      config, 
      onScanSuccess, 
      (err) => { /* ignore frame errors */ }
    );
    document.getElementById('scanFeedback').innerText = "Point camera at Faculty Screen";
  } catch (e) {
    document.getElementById('scanFeedback').innerText = "Camera Error: " + e;
    // Fallback try
    try {
      await html5QrCode.start({ facingMode: "user" }, config, onScanSuccess);
    } catch(e2) { alert("Camera failed. Please check permissions."); }
  }
}

function stopScanner() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
      showPanel('homePanel');
    });
  } else {
    showPanel('homePanel');
  }
}

async function onScanSuccess(decodedText) {
  if (html5QrCode) html5QrCode.stop(); // Stop scanning once we get a hit
  document.getElementById('scanFeedback').innerText = "Processing...";
  
  // Verify manual input matches
  const dobInput = document.getElementById('vPass').value.trim();
  if (dobInput !== profile.dob) {
    alert(`DOB Verification Failed! Please enter ${profile.dob} to confirm identity.`);
    return;
  }

  try {
    // 1. Extract Token from URL or Raw Text
    let tokenStr = decodedText;
    let signature = "";
    
    // Check if it's the new URL format
    if(decodedText.includes("token=") && decodedText.includes("sig=")) {
      const url = new URL(decodedText.startsWith("http") ? decodedText : "https://dummy.com/"+decodedText);
      tokenStr = url.searchParams.get("token");
      signature = url.searchParams.get("sig");
    }

    // 2. Decode Token
    const payload = JSON.parse(atob(tokenStr));
    
    // 3. Validation
    if(payload.slot_id !== currentSlot.id) throw "QR is for a different session!";
    if(Date.now()/1000 > payload.exp) throw "QR Code Expired! Scan a fresh one.";

    // 4. Write to Firestore (This updates Faculty Panel)
    await db.collection('checkins').add({
      slot_id: currentSlot.id,
      student_uid: user.uid,
      name: profile.name,
      reg_no: profile.reg_no,
      email: user.email,
      ts_server: firebase.firestore.FieldValue.serverTimestamp(),
      ts_client: new Date(),
      lat: lastGeo ? lastGeo.latitude : null,
      lng: lastGeo ? lastGeo.longitude : null,
      acc: lastGeo ? lastGeo.accuracy : null,
      method: 'APP_SCAN',
      result: 'OK'
    });

    // 5. Success
    document.getElementById('successOverlay').classList.add('active');
    
  } catch (e) {
    alert("Verification Failed: " + (e.message || e));
    showPanel('homePanel');
  }
}

// 6. RAISE TOKEN LOGIC (Fixed)
document.getElementById('raiseBtn').onclick = async () => {
  const reason = document.getElementById('rtReason').value.trim();
  const statusDiv = document.getElementById('rtStatus');
  
  if (!currentSlot) {
    statusDiv.innerText = "‚ùå No live session found to raise token for.";
    return;
  }
  if (!reason) {
    statusDiv.innerText = "‚ö†Ô∏è Please enter a reason.";
    return;
  }

  statusDiv.innerText = "Sending...";
  
  try {
    await db.collection('raise_tokens').add({
      slot_id: currentSlot.id, // Now guaranteed to exist
      student_uid: user.uid,
      email: user.email,
      reg_no: profile.reg_no,
      student_name: profile.name,
      reason: reason,
      state: 'open',
      created_at: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    statusDiv.innerText = "‚úÖ Token Raised! Wait for faculty approval.";
    document.getElementById('rtReason').value = "";
    
    // Listen for resolution
    listenForTokenResolution(user.uid, currentSlot.id);
    
  } catch (e) {
    statusDiv.innerText = "Error: " + e.message;
  }
};

function listenForTokenResolution(uid, slotId) {
  db.collection('raise_tokens')
    .where('slot_id', '==', slotId)
    .where('student_uid', '==', uid)
    .onSnapshot(snap => {
      snap.docChanges().forEach(change => {
        if(change.type === 'modified') {
          const data = change.doc.data();
          if(data.state === 'accepted') alert("Faculty APPROVED your token!");
          if(data.state === 'denied') alert("Faculty DENIED your token.");
        }
      });
    });
}
</script>
</body>
</html>
